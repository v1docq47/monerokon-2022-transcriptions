# Howard Chu (hyc)

_**Howard Chu (hyc) - Decentralizing Monero Mining - How and Why**_

_Monero Konferenco  #MoneroKon2022 Day 1_

[https://youtu.be/vm_Kw5m_Osk](https://youtu.be/vm_Kw5m_Osk)

---

_**Howard Chu (hyc):**_ Welcome to MoneroKon. This is MoneroKon version 2. I’m Howard Chu, I’m here to talk about decentralized mining in Monero. And I’m going to skip over these intro pages. You know, if you don’t know who I am, you can ask Google.

So what do we mean by the topic of mining decentralization? Why does it matter, and what have we done to achieve it? That’s what we’ll talk about in this.

So the big question is why? Why do we care about this? And I suppose the answer requires, you know, looking back at where all of this started.

So Monero is based on CryptoNote, which was designed sometime before 2014. You know, there’s some claims that the first white paper was written in 2012 or 2013, but basically eight or nine years ago. And the CryptoNote design was written to address a lot of flaws that shortcuts in Bitcoin over the years. Bitcoin was intended to be a permissionless, person-to-person electronic cash system. And experience showed that it didn’t really behave like cash. Pseudonymous accounts weren’t private enough, were not as private as cash. A lot of the parameters built into the Bitcoin software, like the fixed block size, were severely hobbling the network. And most importantly it was supposed to be a decentralized system, which grew into becoming heavily centralized.

And again what do we mean by that? We mean decentralizing control, decentralizing power. If you look around at the world today, you see centralized financial systems everywhere, and they’re so easily abused. Anytime you centralize power it’s easily abused. There’s reports about credit card companies that are cutting off businesses from their services, so that those companies can no longer accept payments from their customers. And the same thing happens with payment networks like PayPal — they have strange terms of use, where if you accidentally violate one of them, they’ll freeze your accounts, freeze your funds. The banks themselves, not just the payment processors, the banks themselves will do the same thing as well. We have again multiple examples of that in recent history, if you remember back to the Canadian truckers convoy that was demonstrating against the COVID vaccine, and people were sending donations to those truckers, and the banks were freezing their accounts. And people were sending Bitcoin donations after the bank freezes started happening, and the Canadian government started trying to freeze those payments as well. So you can see that there’s many examples in the real world today, where all of these centralized systems are subject to the wounds of the governments in charge, the people in charge. And so you as the individual user, the individual citizen, you don’t have total control of your finances anymore, over your property. And so again Bitcoin was developed to combat that abuse of centralized power, and it really has failed to deliver on that promise.

If you look at how Bitcoin mining developed over time, it was only for a very short period in the very beginning that Bitcoin mining was done exclusively on PCs, on CPUs. And then because it used such a simple proof-of-work algorithm, the SHA-256 hash, it quickly got adopted onto GPUs, and then GPUs dominated for a couple years. And then people realized: “Oh, we can start building, we can we can program FPGAs to do this, and they can be even more efficient than GPUs”. Because you don’t have to carry all the unused graphics hardware that the mining hash doesn’t need. So big efficiency boost from that and then eventually you get into the professionally built commercial ASICs. And from there the hobbyist miners have been left in the dust, and all of the mining power has been focused in a small handful of companies. In particular there are companies that actually build the mining chips themselves, mining ASICs.

So the first commercial ASIC released in February 2013, and it was modest. It only had a 50 times performance advantage over CPUs. But if you fast forward to today then modern mining ASICs are millions of times more efficient than CPUs. So another effect of having these specialized chips, it directly promotes centralization. It completely defeats the goal of decentralization. These specialized chips are never easily available to the general public. And part of that is because the people who build these chips tend to keep them and mine for themselves before they even bother to sell them. So whatever they sell to the general market is already the previous generation, the obsolete chips that they no longer use for. And in contrast you can buy CPUs from a bunch of different companies at pretty much any shop around the world.

So you find that the dynamic in Bitcoin mining or anything that’s ASICs dependent is self-reinforcing, because the ASICs themselves tend to be scarce, they get concentrated into a small number of hands, small number of organizations. And as an individual person it’s extremely difficult for you to participate in that mining network. If you buy like one or two ASIC miners, you’re not going to get any appreciable return on that cost. So there’s a lot of real life consequences to this lack of decentralization. You can look again in the news just earlier this month the state of New York passed a ban against crypto mining, now as of a few days ago that bill hadn’t yet been signed by the governor, I don’t know what its status is now, but the legislature had already passed it.

And we can look just a few months into last year where again China started banning crypto miners in that country, and the effect in China was pretty drastic as you can see — just over the course of four months from April to July all of these proof-of-work-based blockchains experienced massive drops in their hash rates, all of them except Monero, which in that same four months hash rate grew by thirteen percent. And this shows you just very vividly the significance of having a centralized mining as a weak point in your blockchain, in a blockchain whose sole purpose is to decentralize power. ASIC based mining, centralized mining is a massive weak point in your system.

So one of the things you can draw from that chart is that what we’ve done in Monero to strengthen decentralization has actually been working, it’s been extremely successful. So now we talk about how we’ve done this, what has Monero done that has actually worked so well? And there’s two elements to this that we’ll talk about. First of all is the actual proof of work algorithm which, if you’ve been following along in the past couple of years, you’ll know it’s called RandomX, and it was developed specifically for Monero. And this other system that has been growing recently, it’s a more recent development called P2Pool, which is aimed at decentralizing mining pools. So we’ll talk about both of those.

Just to give you a little bit of history on how the mining hash rates in Monero were working out over the previous few years. The first proof-of-work algorithm for CryptoNote was called CryptoNight and it worked pretty well for Monero all the way up to 2017. During the massive crypto boom of 2017 it became apparent that mining ASICs for CryptoNight were being used on the network, and they were taking over the hash rate. You can see from this chart between the end of 2017 and early 2018 the hash rate increased pretty drastically, I can point that out here. And when we discovered this, the developer community in Monero decided: “Well, we’re going to try and break those ASICs, because we don’t want ASIC mining to dominate the network”. So there was a hard fork in spring of 2018, where we deployed the first variation on CryptoNight, we call that CryptoNight version 1. And that lasted for about six months until the next scheduled hard fork, when we released another variant called CryptoNight version 2. Unfortunately CryptoNight version 2 was only a small tweak to the algorithm, and again by the spring of 2019 there were ASICs mining version 2 algorithm.

And we knew in 2018 that just making these tiny tweaks to CryptoNight was not a sustainable proposition. It was good as an emergency response, as a short-term response, but it wouldn’t keep the network safe going forward. So we started developing a random code-based proof-of-work algorithm. So that work started in 2018, and it took a while to get the work completed and tested, and have security audits performed. Meanwhile in 2019 we did another hard fork and we released CryptoNight version 4 which was borrowing some ideas from the RandomX, which still wasn’t complete, but was rapidly taking shape. So CryptoNight version 4 released in the middle of 2019, and it looked like it was going pretty well. There was actually a lot of resistance in the community to deploying RandomX, because from what we could tell by looking at hash rates CryptoNight version 4 was still working. But as it was these long debates ended and we deployed RandomX on the Monero mainnet in November of 2019. And you can see here where the hash rate changes, because the RandomX hash rate and the CryptoNight hash rates are not directly comparable. But one of the things that we learned after that there were in fact ASICs for CryptoNight version 4 in development. And if we had decided not to deploy RandomX, then they would have dominated network again.

So just to give an idea of how RandomX works or what the design approach was. The main goal here is to develop something that CPUs are best at. So we want to look at what is the task that CPUs are designed for, and they’re designed for running programs, they’re designed for running arbitrary programs. So we decided to develop a virtual CPU with its own instruction set. We could randomly generate code for this CPU and execute it. Of course to actually execute it means we have to translate it into the native code of this real CPU that we’re running on. But in doing so we wind up using most of the major functional parts of a modern CPU.

And this focus on randomized code and fairly complex code is really the reason why RandomX has succeeded so far. Previous proof-of-work algorithms have all been based on single-purpose functions, SHA-256 hash or some other very single purpose code, but CPUs aren’t built to run just one thing, and in general you know a CPU doesn’t ever run any single thing very well — it can always be optimized in specialized hardware. So the strength of the CPU is to be able to run anything. And to exercise that strength you need either a huge library of code or to dynamically generate random code. So that’s the approach that we took is to generate code randomly.

In comparison to some other proof-of-work algorithms that were in use before, you can see first of all the simplest SHA-256 and some of these other hash based algorithms — they actually have no complexity, no computational complexity to them at all, they don’t do random memory accesses, they don’t do complex math, all they do is you feed data in one end and they crunch it, and data comes out the other end, that’s the basic operation for SHA-256.

The X11 and X16R algorithms all they do is take 11 or 16 different hash algorithms and string them up together in a sequence, so they’re not any different from a single hash algorithm in terms of complexity.

CryptoNight and Ethash were the first to try to actually attempt to be ASIC resistant, and they relied on memory hardness, so they relied on the cost of randomly accessing data in main memory. And CryptoNight kind of fell in 2017, because the amount of RAM it was accessing was only two megabytes. That turned out to be easy enough to fit onto a specialized chip, so that the memory hardness aspect of it was defeated. Now Ethash has lasted a little bit longer, but even today they’re already FPGAs and ASICs that are at least two times more efficient than the GPU miners. So again it used a large amount of RAM, say four gigs, eight gigs, I don’t know what they’re up to now, but whatever the memory size they settled on it became practical over the course of years to build chips with that much memory access. So again Ethash hasn’t held that ball over time.

Randprog was my proof of concept for a randomized proof-of-work program algorithm, and it was based on not just data accesses, but instruction accesses. And this is again the key part of a CPU that any other ASIC doesn’t have — most ASICs don’t have instruction fetchers, because they’re just performing hardwired operations. And so this was the first element of complexity that we added to it. And then also we added floating point math, and again most proof-of-work algorithms won’t even touch floating-point math, because the majority of floating-point operations will return imprecise results, and imprecise results means you don’t get a usable hash result at the end. So that would be pointless for most cases but we’ve refined and restricted the range of these operations to guarantee that they always return exact results, and that’s how we make use of them.

CryptoNight/R as I mentioned it borrowed some ideas from the work we were developing in Randprog, but it was still very simple, because it was designed to fit in the memory footprint and the verification time of the existing CryptoNight algorithms. So in terms of overall complexity it wasn’t that great.

And then there’s a ProgPow which was developed as a replacement for Ethash. I don’t think it’s ever actually fulfilled that purpose, but other blockchains have adopted it. And again their idea was to generate random code, but they’re generating random code for GPUs. So it’s again a different kind of dynamic, and it keeps GPUs in the game which isn’t necessarily a good thing.

So we have RandomX, which takes the complexity of all the previous ideas and bumps it up a notch. I won’t go too far into how that works. My entire MoneroKon presentation three years ago was about RandomX, so you can always look that up, if you want to see more details.

So today RandomX is very mature. It’s got full support for x86 and ARM. Even without that intrinsic support you can still run it on other CPUs if you want in interpreted mode, which will be at least 10 or 20 times slower than the native mode, but it’s doable. All of that code is fully integrated into Monerod now. It’s been running on mainnet since November 2019, and all the indications that we’ve seen so far there are still no ASICs being developed for today. Of course it does actually work on GPUs, but the efficiency is at least two times worse than on CPUs, so I don’t believe anybody is practically running on GPUs right now.

So as I mentioned before, we didn’t know at the time that we were developing RandomX, but there were ASICs for CryptoNight v4 already existing. So there really wasn’t a lot of choice going forward if we decide to stay on CryptoNight v4 — the network would have been taken over by ASICs again. And it’s funny to look back on that time, because lots of skeptics were claiming that as easily as ASICs were developed for CryptoNight they would easily be developed for RandomX as well. And again those people had no idea what they were talking about, because the difference in complexity between these algorithms is so great, there was never any chance that was going to happen, not within 18 months, not within 24 months.

So nowadays, back then the AMD CPUs were the best and that’s still true today, they’re still the most efficient, but it looks like Apple’s ARM chips the M1 and M2 can be very competitive in terms of efficiency. The problem is that the Apple OS, macOS software, is just very unreliable, and so you get pretty inconsistent results on the mac platform right now. There’s also another interesting chip to look at, the 5800x3D, which has what they call 3DV cache on chip. And that expands the on-chip cache by at least a factor of four, and ordinarily that would be a great thing for a hungry memory intense algorithm. It turns out that doesn’t have a huge benefit for RandomX, because again RandomX was designed for a system with a two megabyte on-chip cache, and most of the memory operations that RandomX performs fits in that two megabyte window. So throwing more than two megabytes of cache per thread at the algorithm doesn’t really boost its performance, because the extra cash memory isn’t going to get used. And when you expand the size of a cache like that, you’re making it four times bigger, it actually gets a lot slower, so latency goes up and so you don’t get a lot of performance benefit. Now that could change going forward, if the trend going forward, is that you know on-chip caches get much larger as they do this way, where instead of relying on two megabytes per thread we can count on say eight megabytes per thread. Then we can retune RandomX to utilize that cache, and then it would start to make a significant difference.

So that’s it for the proof of work algorithm. Now we’ll talk about pool decentralization. And the big point about mining pool decentralization is there’s a fear that as any mining entity gets too large percentage of the network hash rate, then they can start launching attacks against the network. We call these 51% attacks, although technically these attacks can succeed at much less than 51 percent hash rate. So last week when I was preparing these slides, the network hash rate looked kind of like this, where myxmr.com had 43 percent of the hash rate, and the next two or three mining pools at 14 and 15 percent. And then the P2Pool mining pool, which I’m going to talk about, had six percent.

And you can see that minexmr is definitely the number one by a large margin, more than twice the number two mining pool. And so there is a danger here — if the administrators of the minexmr pool decided to get malicious, they had the opportunity to attack the network either by mining empty blocks to try and slow down transactions, or maybe to try and perform a double spend attack. Historically minexmr has been a very great supporter of Monero, and they’ve had no tendencies to try and attack the network. But it’s again we see how easily centralized power gets subverted by political changes or other things. And so we really just don’t want to be in the position where anybody has that opportunity to launch an attack and that’s why P2Pool is such an important part of this picture.

So what is P2Pool exactly? And funny enough it’s like so many things that Monero has adopted it was originally developed for Bitcoin, and then the Bitcoiners abandoned it. They say: it’s a merge mined sidechain with a relatively fast block rate, and because of the fast block rate it has a pretty high frequency of orphan blocks. And this is actually the characteristic that led to it being abandoned by Bitcoin project. So SChernykh, who was one of the three of us who worked on RandomX, he took the P2Pool stuff and rewrote it from scratch. And then he also added a fix for the orphan block problem, it’s called “uncle blocks” which is a concept that’s used in Ethereum. Ethereum also has a very fast block rate, and the point behind uncle blocks is they allow orphan blocks to be tracked, so they’re not just lost and their hash power discarded. They actually still count for your mining reward. The first general release of P2Pool was last fall, September 2021, and it’s been growing steadily. You can see that from then until now, it’s only been what six, nine months and now it’s six percent of the network.

And just to get an idea of where P2Pool fits in things. You can see how it differs, and how it’s similar to other mining approaches. So prior to P2Pool you had two choices — you could solo mine or you could mine in a centralized mining pool. And if you mine in a centralized pool the benefit you get is you get pretty regularly scheduled payouts. Of course, part of your mining proceeds get paid to the pool as an administration fee, and that could be zero to three percent. But after the fee is deducted you can generally rely on getting paid on a routine basis. Of course, you’re relying on a centralized infrastructure — then the mining pool has their own set of servers that are controlled by the pool administrator, if those servers go down then your miners aren’t able to do anything, unless you redirect them to some other mining pool. The big advantage aside from the regularity of payouts is that you only need a mining program, and you can just get started, you can tell it your wallet address, and tell it the pool server address, and off you go! It’s really easy to set up.

And then as an alternative you can solo mine, where if you successfully mine a block, you get all of the reward yourself instead of sharing it with all the other pool miners. But the probability that you’ll actually mine a block is small. So the frequency of your payouts will be extremely rare. But again the advantages for solo mining is it’s completely under your own control — you run your own Monero node, so stability is up to the stability of your own network, and block selection, transaction selection is all up to your own node. And you can actually solo mine just with Monero, do all by itself, or you can actually use a third-party miner.

And then we get to P2Pool which tries to give you the advantages of both of the previous approaches with none of the disadvantages or hopefully none of the disadvantages, because you are mining in a pool with other miners, that means your payouts are more frequent, they’re on a regular schedule, and with P2Pool you also pay no pool maintenance fees. So it’s like solo mining in that regard, where whatever reward you get is completely yours — there’s no administrative overhead that you’re paying for. The minimum payout is much smaller, because you can get paid more frequently even than with a regular pool. It is completely decentralized, everything again depends on your own node, it’s completely under your own control — your own node controls all of the block selection and transaction selection for the mining. Now it’s a little bit more complex to set up, because in addition to needing a Monero node you also need to run a P2Pool node, and you have to run a third-party miner. You can’t just use the Monero node’s built-in miner for this.

So the reasons to use P2Pool: it’s fully decentralized, it’s fully permissionless, and it’s fully trustless — there’s no pool administrators, there’s no central server, there’s no one else to pay, there’s no pool wallet, and you get payouts directly from the blockchain in the coinbase-transaction. The payout scheme is called PPLNS, pay-per-last N shares, and so any shares that you’ve mined or that you’ve hashed successfully within the window, which is 2160 pool blocks, will count towards your payout if a block is successfully mined. The payout that you get is proportional to the total difficulty of the number of shares that you had in the mining window.

Again you get paid directly from the coinbase-transaction. Now as a consequence of this it only supports mining to a primary address, not to subaddresses. And since coinbase-transaction addresses are public, for your own privacy you should always use a separate dedicated wallet for P2Pool mining, keep that separate from your main exchange or spending wallets or whatever. And interestingly enough the coding P2Pool has a more advanced transaction selection algorithm. So it tends to construct blocks that have a better block reward than Monerod would construct by itself.

So while we call P2Pool a merge mine sidechain, in fact you can have as many sidechains as you want — there’s two built into the code, the main one and the mini. So the mini sidechain is for miners with much smaller hash rate, like if you’re mining on a couple of smartphones or something you might want to use the mini pool instead of the main pool. But anybody can start a sidechain. If you want to start your own local mining club or something with your buddies, you could set up your own sidechain for that. And as of the latest version 17 Monero release P2Pool support is now integrated in the GUI, so it should be a lot easier for newcomers, less techy users to get involved.

And that brings me to the end. I think I ran a little over the time…
