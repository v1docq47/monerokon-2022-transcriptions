# Говард Чу (hyc)

_**Говард Чу (hyc) — Децентрализация майнинга Monero. Зачем она нужна и как этого добиться**_

_Monero Konferenco  #MoneroKon2022 День 1_

[https://youtu.be/Saj6NBZ7-EE](https://youtu.be/Saj6NBZ7-EE)

---

_**Говард Чу (hyc):**_ Добро пожаловать на MoneroKon. Это MoneroKon версия 2. Меня зовут Говард Чу, и я здесь, чтобы рассказать о децентрализованном майнинге Monero. Я пропущу эти вступительные страницы, и если вы не знаете, кто я такой, просто «погуглите».

Итак, что мы подразумеваем под темой децентрализации майнинга? Почему это важно, и что мы сделали для её достижения? Об этом мы и поговорим  сегодня.

Итак, главный вопрос — почему? Почему нас это волнует? И я полагаю, что для ответа на этот вопрос нужно вспомнить, с чего всё началось.

Итак, в основе Monero лежит протокол CryptoNote, разработанный ещё до 2014 года. Некоторые утверждают, что первая «белая книга» была написана в 2012 или 2013 году, но, по сути, он был реализован восемь или девять лет назад. CryptoNote был написан, чтобы устранить то множество недостатков, которое появилось у Bitcoin с годами. Bitcoin задумывался как не требующая разрешений система электронных денег, которой люди могли бы пользоваться без посредников. Но опыт показал, что на самом деле Bitcoin не работает как наличные. Псевдонимные аккаунты не обеспечивали той же приватности, что наличные. Многие параметры, заложенные в программное обеспечение Bitcoin, например, фиксированный размер блока, сильно тормозили работу сети. Но самое главное, задуманная как децентрализованная система стала совершенно централизованной.

И снова, что мы под этим подразумеваем? Мы имеем в виду децентрализацию контроля, децентрализацию власти. Если вы посмотрите на сегодняшний мир, то повсюду увидите централизованные финансовые системы, которыми так просто злоупотреблять. Любая централизованная власть становится предметом злоупотреблений. Так, например, компании, занимающиеся выпуском кредитных карт, отключают целые предприятия от своих сервисов, и такие предприятия более не могут принимать платежи от своих клиентов. То же самое происходит с платёжными сетями, такими как PayPal — у них есть странные условия использования, и если вы случайно нарушите одно из них, ваши счета, ваши средства будут заморожены. Да и сами банки, не только платёжные операторы, сами банки могут делать то же самое! Тут мы тоже имеем множество примеров в совсем недавнем прошлом. Достаточно вспомнить автоколонну канадских дальнобойщиков, протестовавших против вакцины от COVID. Люди отправляли пожертвования этим дальнобойщикам, а банки просто замораживали счета. После этого люди начали переводить пожертвования в Bitcoin, но канадское правительство также попыталось заморозить эти переводы. Таким образом, сегодня в реальном мире существует много примеров подчинения централизованных систем воле правительств и прочих ответственных лиц. И поэтому вы, как отдельно взятый пользователь, гражданин, не имеете полного контроля над своими финансами, над своей собственностью. И повторю: Bitcoin был разработан для борьбы с подобным злоупотреблением со стороны централизованной власти, но не оправдал надежд.

Если посмотреть, как изменялся процесс майнинга Bitcoin с течением времени, то в самом начале он осуществлялся исключительно с помощью PC, обычных CPU. Затем, поскольку использовался очень простой алгоритм доказательства работы, SHA-256, довольно скоро для майнинга стали применяться GPU, и в течение нескольких лет GPU доминировали. А потом люди поняли: «О, мы можем для этого создавать и программировать FPGA, и они будут даже эффективней, чем GPU». Правильно, ведь теперь не нужно было задействовать всё неиспользуемое графическое оборудование для вычисления хеша. Таким образом, эффективность выросла, и, в конце концов, люди перешли к использованию профессионально построенных, коммерческих схем ASIC. И с этого момента майнеры-любители остались не у дел, а вся мощь майнинга сосредоточилась в руках горстки компаний. В частности, есть компании, которые фактически сами и создают схемы для майнинга, те самые ASIC.

Первая коммерческая ASIC появилась в феврале 2013 года, и её параметры были довольно скромными. Она имела лишь 50-кратное преимущество в производительности по сравнению с CPU. Но если перенестись в день сегодняшний, современные ASIC уже в миллионы раз эффективнее CPU. Таким образом, ещё одним эффектом применения этих специализированных схем является централизация. Это полностью нивелирует задачу децентрализации. Специализированные схемы никогда не будут доступны широкой публике. Отчасти потому, что люди, создающие эти схемы, прежде чем продать их, как правило, сами пользуются ими для майнинга. Поэтому всё, что они продают широкому потребителю — это уже предыдущее поколение, устаревшие схемы, которые сами они больше не используют. И напротив, CPU самых разных производителей можно купить практически в любом магазине по всему миру.

Таким образом, динамика майнинга Bitcoin или чего-то другого с помощью ASIC усиливается сама по себе, потому что производительные ASIC становятся дефицитом — они концентрируются у небольшого количества майнеров, небольшого количества организаций. И вам, как отдельному взятому человеку, будет крайне сложно участвовать в майнинге. Если вы купите один или два майнера на базе ASIC, вы не получите ощутимой прибыли от понесённых затрат. Так что отсутствие децентрализации имеет множество реальных последствий. Достаточно посмотреть новости: в начале этого месяца в штате Нью-Йорк был наложен запрет на майнинг криптовалют. Ну, ещё несколько дней назад данный законопроект пока не был подписан губернатором, и я не знаю, как обстоят дела сейчас, но законодательный орган штата уже одобрил его.

Точно так же несколько месяцев назад, в прошлом году, китайские власти решили запретить майнинг криптовалют в своей стране, и последствия этого решения были довольно ощутимыми. Как можно увидеть, всего за четыре месяца, с апреля по июль, все блокчейны на базе алгоритма доказательства работы испытали сильное падение хешрейта. Все, кроме блокчейна Monero, хешрейт которого за те же четыре месяца вырос на тринадцать процентов. И это наглядно демонстрирует, насколько губителен централизованный майнинг для блокчейна, единственной целью которого является децентрализация мощи. Возможность майнинга с помощью ASIC, централизованного майнинга — это самое слабое место всей системы.

Итак, на основе этого графика можно прийти к выводу, что то, что мы сделали в Monero для усиления децентрализации, действительно работает, и сделано это было чрезвычайно успешно. А теперь поговорим о том, как мы этого добились. Что было сделано проектом Monero для того, чтобы всё сработало настолько хорошо? И мы рассмотрим два элемента. Во-первых, это алгоритм доказательства работы, который, если вы следили за развитием событий последние пару лет, то знаете, что он называется RandomX и был разработан специально для Monero. И во-вторых, это другая система, которая развивается в последнее время. Это новая разработка под названием P2Pool, целью которой является децентрализация майнинг-пулов. И мы поговорим об обеих этих системах.

Для начала немного истории, чтобы понять, как обеспечивался хешрейт при майнинге Monero в течение нескольких предыдущих лет. Первый алгоритм доказательства работы, заменивший CryptoNote, назывался CryptoNight, и он довольно хорошо работал вплоть до 2017 года. Во время криптовалютного бума 2017 года стало очевидно, что при майнинге в соответствии с алгоритмом используются схемы ASIC, отбирающие значительную часть хешрейта. На этом графике виден резкий рост хешрейта в период с конца 2017 до начала 2018 года, вот, как показано здесь. И когда мы обнаружили это, сообщество разработчиков Monero решило: «Что ж, мы попытаемся выкинуть ASIC из сети, потому что мы не хотим, чтобы ASIC-майнинг доминировал в ней». Поэтому весной 2018 года был реализован хардфорк, в рамках которого и был развёрнут первый вариант CryptoNight, названный нами CryptoNight, версия 1. Эта версия использовалась около шести месяцев вплоть до следующего запланированного хардфорка, когда был выпущен другой вариант под названием CryptoNight, версия 2. К сожалению, вторая версия CryptoNight была лишь небольшой доработкой алгоритма, и к весне 2019 года в сети снова появились ASIC, способные осуществлять майнинг, справляясь со второй версией алгоритма.

И тогда в 2018 году мы поняли, что внесение таких незначительных изменений в CryptoNight не является устойчивым решением. Да, это было хорошо в качестве экстренной, краткосрочной реакции, но не обеспечивало безопасности сети в будущем. Поэтому мы приступили к разработке алгоритма доказательства работы на основе случайного кода. Эта работа началась в 2018 году, и потребовалось некоторое время, чтобы завершить её, провести тестирование и аудит безопасности. Тем временем в 2019 году состоялся ещё один хардфорк и была реализована четвёртая версия CryptoNight, которая заимствовала некоторые идеи алгоритма RandomX, работа над которым все ещё не была завершена, но который быстро приобретал определённые очертания. Итак, CryptoNight версии 4 появился в середине 2019 года, и казалось, что дела идут довольно хорошо. И в сообществе появилось много противников развёртывания RandomX, потому что, насколько можно было судить по хешрейту, четвёртая версия CryptoNight действительно работала. Но в итоге продолжительные дебаты закончились, и в ноябре 2019 года RandomX был развёрнут в основной сети Monero. И здесь можно увидеть, как поменялся хешрейт, потому что хешрейт RandomX и хешрейт CryptoNight просто несопоставимы. Уже позже мы узнали, что в разработке находились ASIC для четвёртой версии CryptoNight, и если бы мы решили не внедрять RandomX, то они снова бы доминировали в сети.

Итак, немного информации, чтобы составить представление о том, как работает RandomX, и каков был подход к разработке. Главная цель заключалась в разработке алгоритма, с которым лучше всего бы справлялись CPU. То есть, необходимо было учесть, для решения каких задач предназначены CPU, а они предназначены для выполнения программ, случайных программ. Поэтому мы решили разработать виртуальный CPU с собственным набором инструкций, чтобы мы могли генерировать случайный код для этого CPU, который бы выполнял его. Безусловно, чтобы код выполнялся, было необходимо перевести его в «родной» код реального CPU, на котором он должен выполняться. Но при этом требовалось использовать большинство основных функциональных частей современного CPU.

Особое внимание, уделённое рандомизации и достаточной сложности кода, стало причиной успеха RandomX. Все предыдущие алгоритмы доказательства работы были основаны на выполнении одной функции, вычислении хеша SHA-256 или выполнении какого-то другого конкретного кода. Но CPU разрабатываются вовсе не для выполнения одной задачи, и, как известно, CPU никогда не выполняет какую-то одну задачу достаточно хорошо — его всегда можно оптимизировать, создав специализированное оборудование. Таким образом, сильной стороной CPU является то, что он может выполнять всё, что угодно. И чтобы воспользоваться этой сильной стороной, требуется либо использовать огромную библиотеку, либо динамически генерировать случайный код. Мы использовали второй подход — стали генерировать случайный код.

Если сравнивать с некоторыми другими алгоритмами доказательства работы, которые использовались ранее, можно увидеть, что, прежде всего, простейший SHA-256 и некоторые другие алгоритмы, основанные на хешировании, на самом деле не обладают никакой вычислительной сложностью — они не предполагают случайных обращений к памяти, сложных математических вычислений. Всё, что они делают, так это передают данные в один конец, где данные обрабатываются, а затем выходят с другого конца. Это основной принцип работы SHA-256.

Алгоритмы X11 и X16R — это просто 11 или 16 различных последовательно объединённых алгоритмов хеширования, поэтому по сложности они ничем не отличаются от отдельно взятого алгоритма хеширования.

CryptoNight и Ethash были первой попыткой обеспечить устойчивость к ASIC-майнингу, и они полагались на высокие требования к объёму используемой памяти, то есть на затраты, связанные со случайным доступом к данным основной памяти. В 2017 году CryptoNight продемонстрировал свою несостоятельность, потому что объём RAM, к которой он обращался, составлял всего два мегабайта. Оказалось, что это достаточно легко решается с помощью специализированного чипа, так что такой подход потерпел неудачу. Ethash продержался немного дольше, но даже сегодня существуют FPGA и ASIC, которые, по крайней мере, в два раза эффективнее майнеров на базе GPU. И вновь алгоритм предполагал использование большого объёма RAM, скажем, четыре гига, восемь гигов, не знаю, сколько он составляет сегодня, но какой бы объём памяти не выбирался, в течение нескольких лет создавались чипы с необходимым объёмом доступа к памяти. Так что, и Ethash долго не продержался.

Randprog стал моим доказательством концепции рандомизированного алгоритма доказательства работы, и он уже был основан не только на доступе к данным, но и на доступе к инструкциям. И, опять же, это ключевая часть работы CPU, которой нет ни у каких ASIC — большинство ASIC не занимаются выборкой команд, потому что они просто производят исключительно жёстко заданные операции. Поэтому это был первый добавленный нами элемент сложности. Затем мы также добавили  операции с плавающей запятой. И снова, большинство алгоритмов доказательства работы не используют операций с плавающей запятой, потому что большинство таких операций выдают неточные результаты, а неточные результаты означают, что в конце вы не получите пригодный для использования хеш. Поэтому в большинстве случаев это было бы просто бессмысленно. Но мы усовершенствовали и ограничили диапазон этих операций, чтобы гарантировать получение точных результатов. И именно в таком виде мы их и используем.

CryptoNight/R, как я уже говорил, заимствовал некоторые идеи Randprog. Но и этот алгоритм всё ещё был слишком прост, потому что был разработан так, чтобы соответствовать объёму памяти и времени верификации уже существующих версий CryptoNight. Так что с точки зрения общей сложности он был не так уж совершенен.

А потом появился ProgPow, который разрабатывался как замена Ethash. Не думаю, что он когда-либо действительно соответствовал поставленной цели, но другие блокчейны стали использовать его. И вновь основная идея заключалась в генерации случайного кода. Но код генерировался для графических процессоров. Таким образом, это, опять же, другой вид динамики, и позволяет заниматься майнингом с помощью GPU, что не всегда хорошо.

И теперь у нас есть RandomX, который задействует сложность всех предыдущих решений и поднимает её на новый уровень. Я не буду углубляться в принципы работы алгоритма. Три года назад на MoneroKon я посвятил целую презентацию исключительно RandomX, и вы всегда можете посмотреть её и узнать подробности.

На сегодняшний день RandomX представляется довольно зрелым решением. Он полностью поддерживает x86 и ARM. Но даже без этой поддержки вы можете выполнять его на других CPU в интерпретируемом режиме, что, правда, будет, по крайней мере, в 10 или 20 раз медленнее, чем в «родном» режиме, но это вполне возможно. Весь код сейчас полностью интегрирован в Monerod. Он работает в основной сети, начиная с ноября 2019 года, и по всем наблюдаемым до сих пор признакам на сегодняшний день никаких ASIC, способных выполнить этот алгоритм, не разрабатывается. Конечно, он работает и на GPU, но его эффективность будет, по крайней мере, в два раза ниже, чем на CPU. Поэтому я не думаю, что кто-то сейчас станет использовать его с GPU.

Как я уже упоминал, когда мы разрабатывали RandomX, мы ещё не знали, что уже существуют ASIC, способные справиться с CryptoNight v4. Так что у нас не было особого выбора — если бы мы решили остаться на CryptoNight v4, сеть снова была бы захвачена чипами ASIC. Забавно вспоминать то время, когда многие скептики утверждали, что так же легко, как ASIC разрабатывались под CryptoNight, они будут разрабатываться и под RandomX. Эти люди понятия не имели, о чём они говорят, потому что разница сложности этих алгоритмов настолько велика, что не было ни единого шанса, что это произойдёт ни в течение 18, ни в течение 24 месяцев.

Итак, в то время процессоры AMD были лучшими, что актуально и сегодня — они по-прежнему самые эффективные — но, похоже, и ARM-чипы M1 и M2 от Apple могут оказаться довольно конкурентоспособными с этой точки зрения. Проблема в том, что Apple OS, программное обеспечение macOS, довольно ненадёжно, и поэтому на платформе mac на данный момент можно получить довольно противоречивые результаты. Есть ещё один интересный чип, на который стоит обратить внимание — 5800x3D. Он имеет так называемый 3DV кэш. Это увеличивает объём кэша на кристалле, по крайней мере, в четыре раза. Как правило, это было бы отличным решением с точки зрения алгоритмов, требующих использования большого объёма памяти. Но, как оказалось, RandomX это не даёт значительного преимущества, поскольку, RandomX был разработан для системы с двухмегабайтным кэшем на кристалле, и большинство операций с памятью, которые выполняет RandomX, укладываются в это окно. Таким образом, увеличение объёма кэш-памяти более чем на два мегабайта на поток не приведёт к реальному росту производительности алгоритма, поскольку дополнительная кэш-память не будет использована. И если увеличить размер кэша, например, в четыре раза, он будет работать намного медленнее, увеличится задержка, и никакого повышения производительности добиться не удастся. Это может измениться в будущем, если кэш на кристалле станет намного больше, как это происходит сейчас, и вместо того, чтобы полагаться на два мегабайта на поток, мы сможем рассчитывать, скажем, на восемь мегабайт на поток. Тогда мы перенастроим RandomX для использования этого кэша, и только тогда это действительно будет иметь существенное значение.

Вот и всё, что касается алгоритма доказательства работы. А теперь мы поговорим о децентрализации пулов. Важным моментом в децентрализации майнинг-пулов является то, что если кто-нибудь, занимающийся майнингом, захватит слишком большой процент хешрейта сети, то он сможет атаковать сеть. Мы называем это атаками 51%, хотя технически такие атаки могут быть успешными при обладании гораздо меньшим процентом хешрейта. На прошлой неделе, когда я готовил эти слайды, хешрейт сети выглядел примерно так: пул myxmr.com имел 43 процента хешрейта, а следующие за ним два или три пула — по 14 и 15 процентов. P2Pool, о котором я собираюсь рассказать, на тот момент имел шесть процентов.

Можно увидеть, что minexmr определённо лидирует с большим отрывом, более чем в два раза обгоняя второй пул. И в данном случае опасность состоит в том, что если администраторы пула minexmr решат злоупотребить этим фактом, у них будет возможность атаковать сеть либо путём майнинга пустых блоков, что замедлит проведение транзакций, либо, возможно, путём двойной траты. До сих пор minexmr поддерживали Monero, и не было никаких признаков того, что они собираются атаковать сеть. Но мы знаем, как централизация власти может быть пагубно использована в силу политических изменений или других факторов. И мы не хотим оказаться в положении, когда у кого-то будет возможность провести атаку. Именно поэтому P2Pool является важной частью общей картины.

Так что же такое P2Pool? Забавно, но, как и многие другие вещи, взятые на вооружение Monero, он изначально разрабатывался для Bitcoin, но те отказались от него. Причина состояла в том, что это сайдчейн, где проводится совместный майнинг с относительно высокой скоростью вычисления блоков, а из-за высокой скорости в нём довольно часто будут появляются «осиротевшие» блоки, не включаемые  в блокчейн. И именно это привело к тому, что проект Bitcoin отказался от этой идеи. И поэтому SChernykh, который был одним из троих разработчиков RandomX, взял P2Pool и переписал его с нуля. А затем он же исправил проблему, связанную с «осиротевшими» блоками, введя так называемые анкл-блоки. Ту же концепцию использует Ethereum. У Ethereum также очень высокая скорость вычисления блоков, и смысл анкл-блоков состоит в том, что они позволяют отслеживать осиротевшие блоки, и поэтому они не теряются и их доля хешрейта не отбрасывается. Они по-прежнему учитываются при расчёте вознаграждения за майнинг. Первая версия P2Pool появилась прошлой осенью, в сентябре 2021 года, и он постоянно развивается. Как можно увидеть, что с того момента и до настоящего времени прошло всего шесть-девять месяцев, и сейчас пул имеет уже шесть процентов сети.

И просто чтобы составить представление о том, какую роль играет P2Pool, чем он отличается и чем похож на другие подходы к майнингу. До появления P2Pool существовало два варианта: можно было заниматься соло-майнингом или делать это в централизованном пуле. И если заниматься майнингом в централизованном пуле, то преимущество будет заключаться в регулярном получении выплат. Конечно, часть дохода от майнинга будет перечисляться пулу в качестве административной комиссии, размер которой может составлять от нуля до трёх процентов. Но после вычета комиссии вы можете рассчитывать на регулярную выплату. Безусловно, приходится полагаться на централизованную инфраструктуру — у майнинг-пула есть собственный ряд серверов, которые контролируются администратором пула, и если эти серверы выйдут из строя, то ваши майнеры не смогут ничего сделать, если только вы не переключите их на какой-нибудь другой пул. Большим преимуществом, помимо регулярной выплаты, является то, что для начала майнинга вам потребуется только специальная программа, после чего вы тут же сможете начать работу: нужно будет указать адрес своего кошелька, адрес сервера пула, и вперёд! Всё настраивается очень просто.

В качестве альтернативы вы можете заняться соло-майнингом, где в случае успешного вычисления блока вы получите сразу всё вознаграждение, а не разделите его с остальными майнерами, присутствующими в пуле. Но вероятность того, что вы вычислите блок, реально мала. Поэтому выплаты вы будете получать крайне редко. Но, опять же, преимущества соло-майнинга состоят в том, что он полностью находится под вашим контролем — вы управляете собственным узлом Monero, и стабильность зависит от стабильности вашей собственной сети, а выбор блоков, выбор транзакций — от вашего собственного узла. И вы можете заниматься майнингом исключительно Monero, делать всё самостоятельно, или же использовать сторонний майнер.

И ещё есть P2Pool, который обладает преимуществами обоих предыдущих подходов и, как я надеюсь, без их недостатков, потому что вы занимаетесь майнингом в пуле с другими майнерами, а это означает, что ваши выплаты происходят чаще, регулярнее, и в случае P2Pool вы также не платите за услуги пула. Это уже похоже на соло-майнинг, где любое вознаграждение, которое вы получаете, полностью принадлежит вам, то есть, здесь нет никаких административных комиссий. Минимальная выплата намного меньше, потому что вы сможете получать деньги чаще, чем в обычном пуле. P2Pool полностью децентрализован, и всё, опять же, зависит от вашего собственного узла, вы полностью контролируете его — ваш собственный узел контролирует выбор блоков и выбор транзакций при майнинге. Его немного сложнее настроить, потому что в дополнение к узлу Monero вам также придётся создать узел P2Pool, и вам будет необходимо запускать сторонний майнер. Вы не сможете просто пользоваться встроенным майнером узла Monero.

Итак, почему стоит использовать P2Pool: это полностью децентрализованный пул, он полностью лишён прав доступа и не требует доверия — у него нет администраторов, нет центрального сервера, вам никому не придётся платить, у пула нет кошелька, и вы получаете выплаты непосредственно из блокчейна в coinbase-транзакции. Схема выплат называется PPLNS и предлагает оплату N-ного количества последних долей, и поэтому все доли, которые вы вычислили или успешно хешировали в пределах окна, размер которого составляет 2160 блоков пула, входят в получаемую вами выплату, когда блок будет успешно вычислен. Выплата, которую вы получите, пропорциональна общей сложности количества долей, которые вы вычислили в окне.

Опять же, вы получаете выплату непосредственно в coinbase-транзакции. Как следствие, средства выводятся только на основной адрес, а не на подадреса. А поскольку адреса coinbase-транзакций являются публичными, при майнинге с помощью P2Pool для обеспечения приватности всегда необходимо использовать отдельный, выделенный кошелёк и хранить его отдельно от кошельков, которыми вы пользуетесь на бирже, для личных расходов или чего-либо ещё. И что интересно, код P2Pool имеет более продвинутый алгоритм выбора транзакций. Поэтому он, как правило, создаёт блоки с большим вознаграждением, чем в случае с Monerod.

И несмотря на то, что мы называем P2Pool сайдчейном для совместного майнинга, по сути, у вас может быть сколько угодно сайдчейнов — код предполагает наличие двух: основного и мини. Мини сайдчейн предназначен для майнеров с низким хешрейтом, например, если вы занимаетесь майнингом с помощью пары смартфонов. В этом случае вы можете использовать мини пул вместо основного. Но любой пользователь может создать сайдчейн. Если вы захотите организовать собственный, местный клуб майнеров или что-то подобное со своими приятелями, для этого вы сможете создать свой сайдчейн. А поскольку в последней, семнадцатой версии протокола Monero поддержка P2Pool интегрирована в GUI, новичкам и менее технически подкованным пользователям будет намного проще заняться майнингом.

И на этом я заканчиваю. Кажется, я немного превысил отведённое мне время...
